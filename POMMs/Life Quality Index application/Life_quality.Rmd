---
title: "Application Life quality"
author: "Lapo Santi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(ggplot2)
library(ggside)
library(dplyr)
library(readr)
library(tidyverse)
```


- **OECD Better Life Index (2011):**
  - Initiated by the Organisation for Economic Co-operation and Development (OECD).
  - Aims to create economic indicators capturing dimensions of economic and social progress.
  - Focuses on four key areas: environmental sustainability, increased well-being, reduced inequality, and system resilience.
  - Promotes a "beyond growth" approach, encouraging public and policymaker collaboration.

- **Index Topics (24):**
  - Different dimensions among which: Housing, Income, Jobs, Community, Education, Environment, Governance, Health, Life Satisfaction, Safety, Workâ€“life balance.
  - Official definitions provided in the OECD Better Life Index.
  - Assigns equal weights to the 11 topics.
  - Generates scores and rankings for 30+ countries based on well-being aspects.
  
- **How to adapt it to our SST model**
  - Comparative process involves assigning a score 'k' when one country scores higher than another on 'k' attributes.
  $$
  \text{Country}_i \text{ is scoring better than}  \text{ Country }_j \text{ on } k \text{ different dimensions} \implies A_{ij}= k
  $$
  - Results in pairwise comparisons, offering an assessment of countries' performance against each other.

- **Essence of the Approach:**
  - Focuses on evaluating relative strengths across multiple attributes.
  - Quantifies these comparisons to derive a comprehensive understanding of overall performance among countries.


```{r}
setwd("/Users/lapo_santi/Desktop/Nial/POMM_pairwise/POMMs/Life Quality Index application/")
lqi_data<-read_csv("/Users/lapo_santi/Desktop/Nial/POMM_pairwise/POMMs/Life Quality Index application/BLI_10122023201930864.csv")

head(lqi_data)

lqi_data=lqi_data %>% group_by(Country, Indicator, INDICATOR) %>% summarise(Value = round(mean(Value),3))

number_obs_per_country<- lqi_data %>%group_by(Country,Indicator)%>%summarise(n_indicators = n())

number_country_per_indicator = number_obs_per_country %>% select(Country, Indicator) %>%
  group_by(Indicator) %>% summarise(n_indicators = n())



unique_indicators <- lqi_data %>% select(INDICATOR) %>% unique()
indicator_semantic <- data.frame(Indicator = unlist(unique(lqi_data$Indicator)))
# 0:bad
# 1:good
indicator_semantic$positive = c(0, #"Air pollution"    
                                1, #"Educational attainment"
                                0, #"Employees working very long hours"
                                1, #"Employment rate"      
                                1, #"Feeling safe walking alone at night"     
                                0, #"Homicide rate" 
                                1, #"Household net adjusted disposable income" 
                                1, #"Household net wealth" 
                                1, #"Housing expenditure"     
                                0, #"Labour market insecurity"  
                                1, #life expectancy
                                1, #life satisfaction
                                0, #Long term unemployment rate
                                1, #Personal earnings
                                1, #Quality of support netwokr
                                1, #Self-reported health
                                1, #Stakeholder engagement
                                1, #Student skill
                                1, #Time devoted to leisure and persoal care
                                1, #Voter Turnout
                                1, # Water quality
                                1,#Years in education
                                0,#Dwellings without basic facilities"
                                1 # Rooms per person
                                )

number_country_per_indicator = number_country_per_indicator %>%inner_join(indicator_semantic,by="Indicator")

number_country_per_indicator =number_country_per_indicator %>% mutate(Indicator_sign = ifelse(positive, "Good","Bad"))

# ggplot(number_country_per_indicator, aes(x = reorder(Indicator,n_indicators, decreasing=T), y = n_indicators, fill= factor(Indicator_sign)))+
#   geom_col()+
#   theme(axis.text.x =  element_text(angle = 45, hjust = 1))+
#   labs(title = "Number of observations (countries) for each indicator",
#        x = "Countries",
#        y = "Number of observations",
#        fill = "Indicator")
# 


```


```{r}

one_indicator_example<- lqi_data %>% filter(INDICATOR == unique_indicators$INDICATOR[1]) %>%
  filter(Country != "OECD - Total")

unique_countries <- one_indicator_example %>% select(Country) %>% unique()


indicator_matrix = matrix(0,length(unique_countries$Country),length(unique_countries$Country))
rownames(indicator_matrix) <- unique_countries$Country
colnames(indicator_matrix)<- unique_countries$Country

for(i in 1:nrow(one_indicator_example)){
  for(j in setdiff(1:nrow(one_indicator_example), i)){
    if(one_indicator_example$Value[i] <one_indicator_example$Value[j]){
      indicator_matrix[one_indicator_example$Country[i],one_indicator_example$Country[j]] <- 1
    }
    else if(one_indicator_example$Value[i]>one_indicator_example$Value[j]){
      indicator_matrix[one_indicator_example$Country[j],one_indicator_example$Country[i]] <- 1
    }
  }
}

# Create an empty dataframe
result_df <- expand_grid(unique_countries$Country, unique_countries$Country)
colnames(result_df)<- c("Country1","Country2")
# Display the resulting dataframe

result_df$value = rep(0, nrow(result_df))
result_df$marginal_rows = rep(0, nrow(result_df))
result_df$marginal_cols = rep(0, nrow(result_df))

total_victories_ith <- factor(rowSums(indicator_matrix))
countries_rank = data.frame(country = rownames(indicator_matrix), rank= total_victories_ith)
countries_rank = countries_rank %>%arrange(rank)

for(i in 1:nrow(result_df)){
  result_df$value[i]<- indicator_matrix[result_df$Country1[i],result_df$Country2[i]]
  result_df$marginal_rows[i]<- total_victories_ith[result_df$Country1[i]]
  result_df$marginal_cols[i]<- total_victories_ith[result_df$Country2[i]]
}

result_df = result_df %>% mutate(Country1 = factor(result_df$Country1, levels = countries_rank$country)) %>% mutate(Country2 = factor(result_df$Country2, levels = countries_rank$country))

# 
# # Create the ggplot
# my_plot <- ggplot(result_df, aes(x = Country2, y = Country1)) +
#   geom_tile(color = "grey", aes(fill = as.factor(value))) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   geom_xsidecol(aes(x = Country2, y = marginal_cols)) +
#   geom_ysidecol(aes(y = Country1, x = marginal_rows)) +
#   labs(
#     title = "Labour market insecurity",
#     subtitle = "1 if country i has less insecurity in the labor market than country j",
#     x = "Country 1",
#     y = "Country 2",
#     fill = "Value"
#   )



```




```{r}

all_countries = unique(lqi_data$Country)
all_countries = all_countries[-30]

indicator_matrix = matrix(0,length(unique_countries$Country),length(unique_countries$Country))
rownames(indicator_matrix) <- unique_countries$Country
colnames(indicator_matrix)<- unique_countries$Country

indicator_matrix <- list()
i =1
for (var in 1:24) {
  one_indicator_example<- lqi_data %>% filter(INDICATOR == unique_indicators$INDICATOR[var]) %>%
    filter(Country != "OECD - Total")
  
  unique_countries <- unique(one_indicator_example$Country)
  
  
  indicator_matrix[[var]] = matrix(0, length(unique_countries), length(unique_countries))
  rownames(indicator_matrix[[var]]) <- unique_countries
  colnames(indicator_matrix[[var]])<- unique_countries
  
  for(i in 1:nrow(one_indicator_example)){
    for(j in setdiff(1:nrow(one_indicator_example), i)){
      if(indicator_semantic$positive[which(indicator_semantic$Indicator == one_indicator_example$Indicator[1])]==0){
        if(one_indicator_example$Value[i] < one_indicator_example$Value[j]){
          indicator_matrix[[var]][one_indicator_example$Country[i],one_indicator_example$Country[j]] <- 1
        }
        else if(one_indicator_example$Value[i]>one_indicator_example$Value[j]){
          
          indicator_matrix[[var]][one_indicator_example$Country[j],one_indicator_example$Country[i]] <- 1
        }
      }
      else{
        if(one_indicator_example$Value[i] > one_indicator_example$Value[j]){
          indicator_matrix[[var]][one_indicator_example$Country[i],one_indicator_example$Country[j]] <- 1
        }
        else if(one_indicator_example$Value[i] < one_indicator_example$Value[j]){
          
          indicator_matrix[[var]][one_indicator_example$Country[j],one_indicator_example$Country[i]] <- 1
        }
      }
    }
  }
}

esito = rep(NA, 24) 
for (i in 1:24) {
  esito[i] = all(all_countries %in% rownames(indicator_matrix[[i]]))
}

for(i in 1:24){
  if(esito[i] == F){
    tot_rows = length(all_countries)
    diff = setdiff(all_countries, rownames(indicator_matrix[[i]]))
    items_to_replace = length(diff)
    while(nrow(indicator_matrix[[i]]) < tot_rows){
      indicator_matrix[[i]] = rbind(indicator_matrix[[i]], rep(0, ncol(indicator_matrix[[i]])))
    }
    
    rownames(indicator_matrix[[i]])[(tot_rows-items_to_replace+1):tot_rows]<- diff
    
    while(ncol(indicator_matrix[[i]])<tot_rows){
      indicator_matrix[[i]] = cbind(indicator_matrix[[i]], rep(0, tot_rows))
    }
    colnames(indicator_matrix[[i]])[(tot_rows-items_to_replace+1): tot_rows]<- diff
    
    
    indicator_matrix[[i]]<- indicator_matrix[[i]][,order(colnames(indicator_matrix[[i]]))]
    
    indicator_matrix[[i]]<- indicator_matrix[[i]][order(rownames(indicator_matrix[[i]])),]
    
  }else{
    indicator_matrix[[i]]<- indicator_matrix[[i]][,order(colnames(indicator_matrix[[i]]))]
    
    indicator_matrix[[i]]<- indicator_matrix[[i]][order(rownames(indicator_matrix[[i]])),]
    
  }
}




Y_ij_matrix = Reduce("+",indicator_matrix)
```


```{r}

# Create an empty dataframe
result_df <- expand_grid(all_countries, all_countries)
colnames(result_df)<- c("Country1","Country2")
# Display the resulting dataframe

result_df$value = rep(0, nrow(result_df))
result_df$marginal_rows = rep(0, nrow(result_df))
result_df$marginal_cols = rep(0, nrow(result_df))

total_victories_ith <- factor(rowSums(Y_ij_matrix))
countries_rank = data.frame(country = rownames(Y_ij_matrix), rank= total_victories_ith)
countries_rank = countries_rank %>% arrange(rank)

for(i in 1:nrow(result_df)){
  result_df$value[i]<- Y_ij_matrix[result_df$Country1[i],result_df$Country2[i]]
  result_df$marginal_rows[i]<- total_victories_ith[result_df$Country1[i]]
  result_df$marginal_cols[i]<- total_victories_ith[result_df$Country2[i]]
}

result_df = result_df %>% mutate(Country1 = factor(result_df$Country1, levels = countries_rank$country)) %>% mutate(Country2 = factor(result_df$Country2, levels = countries_rank$country))
```

```{r,out.width="90%"}
# Create the ggplot
ggplot(result_df, aes(x = Country2, y = Country1)) +
  geom_tile(color = "grey", aes(fill = value)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_ysidecol(aes(y = Country1, x = marginal_rows)) +
  labs(
    title = "Pairwise countries quality of life indicator",
    subtitle = "A given entry counts how many times country i scores better than country j",
    x = "Country 1",
    y = "Country 2",
    fill = "Value"
  )
```

## Questions we would be able to solve

1) Which are the countries with a similar life quality?

2) How many different blocks of countries exists among the one considered?

## Advantages of using this method:

1) We are introducing the block structures in a essentially new type of data. Indeed, classical clusters do not account for hierarchical, assortative and disassortative types of dependency as the Stochastic Blockmodel type of blocks-finding does.

2) We are able to claim a certain type of relation between the blocks, that is, transitivity. This nice mathematical property assures us that the clusters are comparable between them, and the clusters are not indifferent to relabeling




